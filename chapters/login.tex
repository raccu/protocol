\section{Login}
In this section we define a flow for logging in at an independent endpoint using an Auth
issued attestation, as well as the process of authenticating the user by the Auth. 

    \subsection{Flow}
    The login flow is given in Figure ~\ref{fig:login} and defined as follows:
        \begin{enumerate}
            \item A user MAY try to access an unauthorized resource on the Server via the Browser.
            \item Server MUST notify the user that he/she needs to authenticate and SHALL refer the Auth he/she 
                  can use to do so.
            \item Upon receiving the information about the Auth, the Browser MUST fetch an authentication challenge
                  from the Auth. It is REQUIRED for the challenge to be combined with the domain name and
                  displayed as a QR code for the user to scan it with the Mobile.
            \item When the user scans an aforementioned QR code with the Mobile, the Mobile MUST authenticate the 
                  user locally by using a built-in biometry. Upon authenticating, the Mobile will sign the 
                  challenge, domain name, and user's email. Afterwards, the Mobile MUST send the challenge and user's
                  email alongside the signature to the Auth.
            \item Auth SHOULD notify the Browser that the authentication is successful and that the attestation is
                  ready.
            \item Browser MUST request the attestation from the Auth by providing a challenge that the Auth issued 
                  as a reference to the authentication session.
            \item Browser MUST submit the attestation to the Server as a proof of user's identity, and thus finishing 
                  the authentication flow.
            \item Server SHOULD issue a new authentication and authorization token to the Browser in order to complete
                  the login process.
        \end{enumerate}
        \input{diagrams/sequence/login.tex}

    \subsection{Requirements}
    The following requirements are made for a login:
        \begin{enumerate}
            \item Provided email MUST exist in the Auth's store.\\
            \textit{Argument:} It is trivial that the Auth cannot authenticate a user it does not have any record
                               of.         

            \item A challenge that the Auth generates MUST rely on a cryptographically secure pseudo-random number 
                  generator (CSPRNG) and MUST NOT be predictable. The challenge SHALL NOT be reused.\\
            \textit{Argument:} If the challenge can be predicted or guessed, an unauthorized party might fetch the
                               attestation or perform an attack from Man-in-the-Middle (MITM) vector of attacks, for
                               instance a relay attack. On the other hand, if the challenge is reused, the system 
                               becomes susceptible to the replay attack. Due to that, the challenge should be 
                               viewed as a nonce.

            \item Mobile MUST NOT expose private key directly.\\
            \textit{Argument:} Since the digital signature is a basis of authentication, an utmost respect to 
                               protecting the confidentiality of the private key should be implemented.

            \item Mobile MUST always require a biometric authentication to allow access to digital signing 
                  capability.\\        
            \textit{Argument:} This is to avoid phishing attacks or other illegal attempts to get the user's 
                               digital signature without his/hers explicit approval.

            \item When a user is prompted to authenticate a scanned QR code, the Mobile MUST disclose the domain that 
                  requires the authentication and is located inside the QR code itself.\\
            \textit{Argument:} This is to stop phishing attacks and also provide the feed-forward to the user.

            \item An attestation SHOULD NOT be permanently stored in the Browser or on the Server but rather deleted once
                  its validity has been proved and the process of authentication is finished. It is RECOMMENDED to handle 
                  the attestation with an utmost care for its confidentiality.\\
            \textit{Argument:} Since the attestation proves the holder's identity, an attacker that obtains a valid
                               attestation might pose as the user identified by the attestation.

            \item An attestation MUST NOT be continuously reused after the login succeeds.\\
            \textit{Argument:} An attestation serves as an initial proof of identity and a continuous exchange of the
                               attestation increases the chances of its hijacking. After the initial authentication, the
                               Server should keep track of the user's identity and his/hers permissions within the system.

            \item An attestation MUST be checked for the time of issuing and \textit{old} attestations MUST NOT be
                  accepted. It is left up to the implementer to define \textit{old}, but it is RECOMMENDED to
                  decline an attestation that was issued over three minutes ago.\\
            \textit{Argument:} Since the attestation proves the holder's identity, an attacker that obtains a valid
                               attestation might pose as the user identified by the attestation. Given that the login
                               flow is not particularly long or dependant upon data entry, a three minute time-to-live 
                               (TTL) period is gracious enough to let the network exchanges happen.

            \item The communication between the Browser and Auth, the Mobile and Auth, and the Browser and Server MUST 
                  rely on a secure channel that provides confidentiality and verifies integrity. It is RECOMMENDED to use
                  up-to-date version of TLS protocol with a well-tested and computationally secure cipher suite.\\      
            \textit{Argument:} The exchanged information should remain confidential given that the challenge is used to
                               identify an authentication session, and later on an attestation is used to authenticate the
                               user.
        \end{enumerate}

    \subsection{Attestation structure}
    An attestation that Auth issues to the user upon authenticating has a structure defined in a Figure 
    ~\ref{fig:attestation}.
    \input{diagrams/attestation.tex}
    Within the structure, a \textit{version} represents a version of the protocol under which an attestation was issued, 
    while \textit{iat} stands for \textit{issued at} and represents a moment at which an attestation was issued. The 
    \textit{domain} contains a domain name of the web service or application that requested the authentication, while 
    \textit{issuer} contains a domain name of the Auth instance. Inside the user information, besides the \textit{name}
    and \textit{email}, a \textit{claim} field signifies a type of registration process that the user underwent upon 
    account creation. In the first version of the protocol, only email verification claim is available, but this field 
    was added with future changes in mind. Lastly, the \textit{signature} field contains a digital signature of all of 
    the other fields, signed by the issuer with his private key that matches his certified public key. 

    \subsection{Successful login}
    If the login is successful, the Server SHOULD communicate with the Browser in a manner of its implementation. Both 
    authentication and authorization from that point forward to the session expiry, as defined by the Server, MUST be 
    within the Server's scope.

    \subsection{Unsuccessful login}
    If the login fails for any reason related to the authentication as described by the protocol, an attempt to 
    authenticate MUST be discarded. It is RECOMMENDED to log an attempt in order to screen a source of multiple invalid 
    requests. Any of the following reasons is considered to be an authentication error:
        \begin{itemize}
            \item An email is not associated with any account.
            \item Challenge does not exist.
            \item The signature cannot be verified with an associated public key.
            \item The signature is invalid.
        \end{itemize}
    If the login fails for any other reason (e.g. network outage), an appropriate message SHOULD be dispatched or left 
    to other protocols for handling, should they offer such capability.

        
