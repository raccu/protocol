\section{Login}
In this section a flow for logging in at an independent endpoint using the Auth issued attestation, as well as the 
process of authenticating the user by the Auth is defined. 

    \subsection{Flow}
    The login flow is given in Figure~\ref{fig:login} on page~\pageref{fig:login} and is defined as follows:
        \begin{enumerate}
            \item A user MAY try to access an unauthorized resource on the Server using the Browser.
            \item Server MUST notify the user that they need to authenticate and SHALL refer the Auth they can use 
                  to do so.
            \item Upon receiving the information about the Auth, the Browser MUST fetch an authentication challenge
                  from the Auth. It is REQUIRED for the challenge to be combined with the domain name and
                  displayed as a QR code for the user to scan it with the Mobile.
            \item When the user scans an aforementioned QR code with the Mobile, the Mobile MUST authenticate the 
                  user locally using a built-in biometry while disclosing the domain that requires the authentication.
                  Upon authenticating, the Mobile will sign the challenge, domain name, and user's email. Afterwards, the
                  Mobile MUST send the challenge and user's email alongside the signature to the Auth.
            \item Auth SHOULD notify the Browser that the authentication is successful and that the attestation is
                  ready.
            \item Browser MUST request the attestation from the Auth by providing a challenge that the Auth issued 
                  as a reference to the authentication session.
            \item Browser MUST submit the attestation to the Server as a proof of user's identity, and thus finishing 
                  the authentication flow.
            \item Server SHOULD issue a new authentication and authorization token to the Browser in order to complete
                  the login process.
        \end{enumerate}
        \input{diagrams/sequence/login.tex}

    \subsection{Attestation structure}
    An attestation that Auth issues to the user upon authenticating has a structure defined in a Figure~\ref{fig:attestation}
    on page~\pageref{fig:attestation}.
    \input{diagrams/attestation.tex}
    Within the structure, a \textit{version} represents a version of the protocol under which an attestation was issued, 
    while \textit{iat} stands for \textit{issued at} and represents a moment at which an attestation was issued. The 
    \textit{domain} contains a domain name of the web service or application that requested the authentication, while 
    \textit{issuer} contains a domain name of the Auth instance. Inside the user information, besides the \textit{name}
    and \textit{email}, a \textit{claim} field signifies a type of registration process that the user underwent upon 
    account creation. In the first version of the protocol, only email verification claim is available, but this field 
    was added with future changes in mind. Lastly, the \textit{signature} field contains a digital signature of all of 
    the other fields, signed by the issuer with their private key that matches their certified public key. 

    \subsection{Successful login}
    If the login is successful, the Server SHOULD communicate with the Browser in a manner of its implementation. Both 
    authentication and authorization from that point forward to the session expiry, as defined by the Server, MUST be 
    within the Server's scope. The attestation used to initially authenticate the user MUST be deleted by both the Browser
    and the Server.

    \subsection{Unsuccessful login}
    If the login fails for any reason related to the authentication as described by the protocol, an attempt to 
    authenticate MUST be discarded. It is RECOMMENDED to log an attempt in order to screen a source of multiple invalid 
    requests. All of the following reasons are considered to be an authentication error:
        \begin{itemize}
            \item An email is not associated with any account.
            \item Challenge does not exist.
            \item The signature cannot be verified by an associated public key.
            \item The signature is invalid.
        \end{itemize}
    If the login fails for any other reason (e.g. network outage), an appropriate message SHOULD be dispatched or left 
    to other protocols for handling, should they offer such capability.

        
